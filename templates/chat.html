<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chatbot - Connex AI</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
         body {
            font-family: 'Inter', Arial, sans-serif;
            margin: 0;
            background-color: #fefefe;
            color: #333;
        }

        .content-wrapper {
            position: relative;
            z-index: 10;
        }
        
        .app-container {
            display: flex;
            width: 100%;
            max-width: 1200px; /* Increased max-width for overall app */
            height: calc(100vh - 160px); /* Adjust height to fit within viewport, accounting for navbar and margin */
            margin: 30px;
            background-color: #fff6f6;
            border-radius: 16px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            overflow: hidden;
            position: relative; /* For hamburger icon positioning */
        }

        /* Hamburger Icon */
        .hamburger-icon {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 1.8em;
            color: #b30000;
            cursor: pointer;
            z-index: 1001; /* Above sidebar */
            padding: 5px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: left 0.3s ease-in-out;
        }

        /* Sidebar Styles */
        .sidebar-container {
            width: 0; /* Hidden by default */
            min-width: 0;
            background-color: #f0f0f0; /* Lighter grey for sidebar */
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            padding: 0;
            transition: width 0.3s ease-in-out, min-width 0.3s ease-in-out;
            overflow: hidden; /* Hide scrollbar when closed */
            position: relative;
            z-index: 1000;
        }
        .sidebar-container.open {
            width: 300px; /* Open width */
            min-width: 300px;
            padding: 20px;
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 15px;
            border-bottom: 1px solid #ccc;
            margin-bottom: 15px;
        }
        .sidebar-header h3 {
            margin: 0;
            color: #333;
            font-size: 1.4em;
        }
        .new-chat-btn {
            background-color: #9370DB; /* Purple from your theme */
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s;
        }
        .new-chat-btn:hover {
            background-color: #7a5bb8;
        }

        .chat-list {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 5px; /* Space for scrollbar */
        }
        .chat-list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        .chat-list-item:hover {
            background-color: #f5f5f5;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .chat-list-item.active {
            background-color: #e0f2f7; /* Light blue for active chat */
            border-color: #a7d9e8;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .chat-list-item.pinned {
            background-color: #fff9e6; /* Light yellow for pinned chats */
            border-color: #ffe0b3;
            order: -1; /* Pinned items appear first */
        }

        .chat-summary-text {
            flex-grow: 1;
            font-size: 0.95em;
            color: #333;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.4;
        }
        .chat-actions {
            display: flex;
            gap: 5px;
            margin-left: 10px;
        }
        .chat-actions button {
            background: none;
            border: none;
            font-size: 1.1em;
            cursor: pointer;
            color: #777;
            transition: color 0.2s;
            padding: 5px;
        }
        .chat-actions button:hover {
            color: #b30000;
        }
        .chat-actions .pin-icon {
            color: #ccc; /* Unpinned color */
        }
        .chat-list-item.pinned .chat-actions .pin-icon {
            color: #ffcc00; /* Pinned color */
        }
        
        /* Main Chatbot Content */
        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            position: relative; /* For alert positioning */
        }

        .chatbot-header {
            background-color: #b30000;
            color: white;
            padding: 20px 25px;
            font-size: 1.8em;
            font-weight: bold;
            text-align: center;
            border-top-right-radius: 16px; /* Only top-right for main content */
            border-top-left-radius: 0; /* No border radius here */
        }

        .chatbot-alert {
            background-color: #ffcccc;
            color: #b30000;
            padding: 18px 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 1.1em;
            font-weight: 500;
            border-bottom: 1px solid #ff9999;
        }
        .chatbot-alert img {
            height: 35px;
            width: 35px;
            margin-right: 15px;
            vertical-align: middle;
        }
        .chatbot-alert-text {
            flex-grow: 1;
            display: flex;
            align-items: center;
        }
        .chatbot-alert .close-btn {
            background: none;
            border: none;
            font-size: 1.8em;
            color: #b30000;
            cursor: pointer;
            padding: 0 8px;
            transition: color 0.2s;
        }
        .chatbot-alert .close-btn:hover {
            color: #800000;
        }
        .chat-messages {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
            max-height: 550px; /* Reduced slightly to fit */
            background-color: #fff;
        }
        .message-row {
            display: flex;
            margin-bottom: 20px;
            align-items: flex-end;
        }
        .message-row.user {
            justify-content: flex-end;
        }
        .message-row.ai {
            justify-content: flex-start;
        }
        .message-bubble {
            max-width: 75%;
            padding: 15px 30px;
            border-radius: 25px;
            line-height: 1.6;
            word-wrap: break-word;
            box-shadow: 0 3px 8px rgba(0,0,0,0.08);
        }
        .message-row.user .message-bubble {
            background-color: #9370DB;
            color: white;
            border-bottom-right-radius: 8px;
        }
        .message-row.ai .message-bubble {
            background-color: #e0e0e0;
            color: #333;
            border-bottom-left-radius: 8px;
        }
        .message-sender {
            font-size: 0.9em;
            color: #777;
            margin-bottom: 8px;
            display: block;
        }
        .message-row.user .message-sender {
            text-align: right;
            margin-right: 30px;
        }
        .message-row.ai .message-sender {
            text-align: left;
            margin-right: 50px;
        }
        .chat-input-area {
            display: flex;
            padding: 20px 25px;
            border-top: 1px solid #eee;
            background-color: #f9f9f9;
            border-bottom-right-radius: 16px;
            border-bottom-left-radius: 0; /* No border radius here */
        }
        .chat-input {
            flex-grow: 1;
            padding: 15px 20px;
            border: 1px solid #ddd;
            border-radius: 30px;
            font-size: 1.1em;
            margin-right: 15px;
            outline: none;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .chat-input:focus {
            border-color: #b30000;
            box-shadow: 0 0 0 4px rgba(179, 0, 0, 0.15);
        }
        .send-button {
            background-color: #b30000;
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 3px 8px rgba(0,0,0,0.15);
        }
        .send-button:hover {
            background-color: #800000;
        }
        .send-button:active {
            transform: scale(0.95);
        }
        .loading-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
            color: #777;
            font-style: italic;
            margin-top: 10px;
            margin-bottom: 10px;
        }
        .loading-indicator .dot {
            width: 10px;
            height: 10px;
            background-color: #777;
            border-radius: 50%;
            margin: 0 4px;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .loading-indicator .dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-indicator .dot:nth-child(2) { animation-delay: -0.16s; }
        .loading-indicator .dot:nth-child(3) { animation-delay: 0s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* Styles for suggested FAQs */
        .suggested-faqs {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        .suggested-faqs h4 {
            color: #555;
            margin-bottom: 10px;
            font-size: 1.05em;
        }
        .suggested-faqs ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-wrap: wrap;
            gap: 8px; /* Space between FAQ buttons */
        }
        .suggested-faqs li {
            display: inline-block;
        }
        .suggested-faq-button {
            background-color: #e6e6e6; /* Light grey for buttons */
            color: #333;
            border: 1px solid #d0d0d0;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s, border-color 0.2s;
            text-decoration: none; /* In case it's an anchor */
        }
        .suggested-faq-button:hover {
            background-color: #dcdcdc;
            border-color: #c0c0c0;
        }

        /* Responsive adjustments */
        @media (max-width: 992px) {
            .app-container {
                margin: 20px;
                height: calc(100vh - 100px);
                max-width: 95%;
            }
            .sidebar-container.open {
                width: 250px;
                min-width: 250px;
            }
            .chatbot-header {
                font-size: 1.6em;
            }
            .chat-messages {
                max-height: 480px;
            }
        }

        @media (max-width: 768px) {
            .app-container {
                margin: 15px;
                height: calc(100vh - 80px);
                max-width: 100%;
                border-radius: 10px;
            }
            .hamburger-icon {
                top: 15px;
                left: 15px;
                font-size: 1.5em;
                padding: 4px;
            }
            .sidebar-container.open {
                width: 220px;
                min-width: 220px;
                padding: 15px;
            }
            .chatbot-header {
                font-size: 1.4em;
                padding: 15px 20px;
            }
            .chatbot-alert {
                font-size: 1em;
                padding: 15px 20px;
            }
            .chatbot-alert img {
                height: 30px;
                width: 30px;
            }
            .chat-messages {
                padding: 20px;
                max-height: 400px;
            }
            .message-bubble {
                padding: 12px 18px;
                font-size: 0.95em;
            }
            .chat-input-area {
                padding: 15px 20px;
            }
            .chat-input {
                padding: 12px 15px;
                font-size: 1em;
            }
            .send-button {
                width: 45px;
                height: 45px;
                font-size: 1.5em;
            }
        }

        @media (max-width: 480px) {
            .app-container {
                margin: 10px;
                height: calc(100vh - 60px);
                border-radius: 8px;
            }
            .hamburger-icon {
                font-size: 1.3em;
                padding: 3px;
                top: 10px;
                left: 10px;
            }
            .sidebar-container.open {
                width: 180px;
                min-width: 180px;
                padding: 10px;
            }
            .sidebar-header h3 {
                font-size: 1.2em;
            }
            .new-chat-btn {
                padding: 8px 12px;
                font-size: 0.85em;
            }
            .chat-list-item {
                padding: 10px 12px;
                margin-bottom: 8px;
            }
            .chat-summary-text {
                font-size: 0.85em;
            }
            .chat-actions button {
                font-size: 1em;
                padding: 3px;
            }
            .chatbot-header {
                font-size: 1.2em;
                padding: 12px 15px;
            }
            .chatbot-alert {
                font-size: 0.85em;
                padding: 12px 15px;
            }
            .chatbot-alert img {
                height: 25px;
                width: 25px;
            }
            .chat-messages {
                padding: 15px;
                max-height: 350px;
            }
            .message-bubble {
                padding: 10px 15px;
                font-size: 0.8em;
            }
            .chat-input-area {
                padding: 12px 15px;
            }
            .chat-input {
                padding: 10px 12px;
                font-size: 0.9em;
            }
            .send-button {
                width: 40px;
                height: 40px;
                font-size: 1.3em;
            }
            .suggested-faq-button {
                padding: 6px 12px;
                font-size: 0.8em;
            }
        }
        /* Idle Timeout Popup Styles */
        #idlePopup {
            display: none;
            position: fixed;
            z-index: 9999;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6);
            justify-content: center;
            align-items: center;
            font-family: 'Poppins', sans-serif;
        }
        #idlePopup > div {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 0 15px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 400px;
            width: 80%;
        }
        #idlePopup button {
            padding: 10px 20px;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin-right: 10px;
        }
        #idlePopup .stay-btn {
            background-color: #28a745;
        }
        #idlePopup .logout-btn {
            background-color: #dc3545;
            margin-right: 0;
        }
    </style>
</head>
<body>
    {% include "includes/bg.html" %}
    <div class="content-wrapper">
        {% include "includes/navbar.html" %}
        
        <div class="app-container">
            <div class="hamburger-icon" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </div>

            <div class="sidebar-container" id="sidebarContainer">
                <div class="sidebar-header">
                    <h3><br><br>Chats</h3>
                    <button class="new-chat-btn" onclick="createNewChatSession()">+ New Chat</button>
                </div>
                <div class="chat-list" id="chatList">
                    </div>
            </div>

            <div class="main-content">
                <div class="chatbot-header">AI Chatbot</div>

                <div class="chatbot-alert" id="chatbotAlert">
                    <div class="chatbot-alert-text">
                        <img src="{{ url_for('static', filename='img/ai_icon.png') }}" alt="AI Icon" onerror="this.onerror=null;this.src='https://placehold.co/35x35/cccccc/333333?text=AI';">
                        CONNEX AI: Chat with Connex AI! Your Personal AI assistant!
                    </div>
                    <button class="close-btn" onclick="document.getElementById('chatbotAlert').style.display='none';">&times;</button>
                </div>

                <div class="chat-messages" id="chatMessages">
                    </div>

                <div class="loading-indicator" id="loadingIndicator">
                    <div class="dot"></div><div class="dot"></div><div class="dot"></div>
                </div>

                <div class="chat-input-area">
                    <input type="text" id="chatInput" class="chat-input" placeholder="Enter Query">
                    <button id="sendButton" class="send-button">&#x27A4;</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const OPENAI_API_KEY = "{{ openai_api_key}}"; 
        console.log("OpenAI API Key received in JS:", OPENAI_API_KEY);

        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendButton = document.getElementById('sendButton');
        const loadingIndicator = document.getElementById('loadingIndicator'); 
        const sidebarContainer = document.getElementById('sidebarContainer');
        const chatList = document.getElementById('chatList');

        let currentSessionId = null;

        loadingIndicator.style.display = 'none';

        const systemMessage = { role: "system", content: "You are Connex AI, a helpful assistant for a digital wellness platform for seniors and volunteers where they can sign up or volunteer for events. Your primary function is to answer questions strictly related to Connex, its website, its events, and general information about digital wellness for seniors. If a user asks a question outside these topics, you must politely decline to answer and gently guide them back to relevant subjects. For example, you can say: 'I'm sorry, I only provide information related to Connex and digital wellness for seniors. How can I help you with that?' Do not engage in political discussions, provide medical diagnoses, or offer financial advice." };
        
        // --- Predefined FAQ Scenarios ---
        const faqResponses = [
            {
                keywords: ["about connex", "what is connex", "connex platform"],
                answer: "Connex is a digital wellness platform designed to connect seniors with volunteers for various events and activities, fostering a supportive community.",
                related: ["How do I register?", "What kind of events are available?", "How can I volunteer?"]
            },
            {
                keywords: ["register", "sign up", "create account", "join connex"],
                answer: "To register, click on the 'Sign Up' button in the navigation bar or go directly to our <a href='/signup' target='_blank'>registration page</a> and follow the prompts to create your account.",
                related: ["Who can register?", "Do I need an email to sign up?", "What information is required for registration?"]
            },
            {
                keywords: ["events", "what events", "find events", "event details", "upcoming events"],
                answer: "We offer a variety of events, including digital literacy workshops, social gatherings, fitness classes, and more. You can browse all upcoming events on our <a href='/usereventpage' target='_blank'>Events page</a>.",
                related: ["How can I join an event?", "Are events free?", "How do I suggest a new event?"]
            },
            {
                keywords: ["volunteer", "how to volunteer", "become a volunteer", "volunteering"],
                answer: "To become a volunteer, navigate to the 'Volunteer' section of our website, or visit our <a href='/volunteer' target='_blank'>Volunteer page</a>. You'll find information on requirements and a sign-up form.",
                related: ["What are the requirements for volunteers?", "What kind of tasks do volunteers do?", "How can I get started as a volunteer?"]
            },
            {
                keywords: ["contact", "support", "help", "customer service", "get in touch"],
                answer: "If you need further assistance, please visit our <a href='/support' target='_blank'>Support page</a> or email us directly at support@connex.com. Our team will be happy to help you.",
                related: ["What are your office hours?", "Do you have a phone number?", "Where can I find FAQs?"]
            },
            {
                keywords: ["digital wellness", "seniors digital", "online safety", "tech tips", "cyber security"],
                answer: "Digital wellness for seniors focuses on empowering older adults to confidently and safely use technology. This includes topics like online safety, privacy, digital literacy, and using technology for connection and well-being.",
                related: ["What are common online scams?", "How can seniors stay safe online?", "Are there workshops on using smartphones?"]
            },
            {
                keywords: ["password reset", "forgot password", "login issues"],
                answer: "If you forgot your password, go to the login page and click on 'Forgot Password'. You will be guided through the steps to reset it.",
                related: ["How do I change my email?", "My account is locked, what do I do?"]
            },
            {
                keywords: ["cancel event", "unregister event", "withdraw from event"],
                answer: "You can cancel your attendance for an event by going to 'My Events' in your profile and selecting the event you wish to cancel.",
                related: ["What is the cancellation policy?", "Can I join another event instead?"]
            },
            {
                keywords: ["visit home", "go to homepage", "connex home"],
                answer: "You can always return to the homepage by clicking the 'Connex AI' logo in the navigation bar or by visiting our <a href='/' target='_blank'>home page</a>.",
                related: ["What is Connex?", "How do I register?"]
            },
            {
                keywords: ["view calendar", "my events calendar"],
                answer: "You can view your signed-up events and volunteered events on the calendar page here: <a href='/calendar' target='_blank'>My Calendar</a>.",
                related: ["How do I sign up for an event?", "How do I remove an event from my calendar?"]
            }
        ];
        
        // Function to toggle sidebar open/close
        function toggleSidebar() {
            sidebarContainer.classList.toggle('open');
        }

        // Renamed from newChat() to clearly reflect its purpose
        async function createNewChatSession() {
            try {
                const response = await fetch('/create_new_chat_session', { method: 'POST' });
                const data = await response.json();
                if (data.status === 'success') {
                    currentSessionId = data.session_id;
                    await fetchChatSessions();
                    await fetchChatHistory(currentSessionId);
                    displayInitialMessageAndFAQs();
                } else {
                    console.error('Failed to create new chat session:', data.message);
                }
            } catch (error) {
                console.error('Error creating new chat session:', error);
            }
        }

        async function fetchChatSessions() {
            try {
                const response = await fetch('/get_chat_sessions');
                const data = await response.json();
                chatList.innerHTML = '';
                if (data.status === 'success' && data.sessions.length > 0) {
                    data.sessions.forEach(session => {
                        const listItem = document.createElement('div');
                        listItem.className = `chat-list-item ${session.session_id === currentSessionId ? 'active' : ''} ${session.pinned ? 'pinned' : ''}`;
                        listItem.dataset.sessionId = session.session_id;
                        listItem.onclick = () => loadChat(session.session_id);

                        const chatSummary = document.createElement('span');
                        chatSummary.className = 'chat-summary-text';
                        chatSummary.textContent = session.name || "New Chat";

                        const chatActions = document.createElement('div');
                        chatActions.className = 'chat-actions';

                        const pinButton = document.createElement('button');
                        pinButton.innerHTML = `<i class="fas fa-thumbtack pin-icon"></i>`;
                        pinButton.title = session.pinned ? "Unpin Chat" : "Pin Chat";
                        pinButton.onclick = (e) => {
                            e.stopPropagation();
                            togglePinChat(session.session_id, !session.pinned);
                        };

                        const renameButton = document.createElement('button');
                        renameButton.innerHTML = `<i class="fas fa-pen"></i>`;
                        renameButton.title = "Rename Chat";
                        renameButton.onclick = (e) => {
                            e.stopPropagation();
                            renameChat(session.session_id);
                        };

                        const deleteButton = document.createElement('button');
                        deleteButton.innerHTML = `<i class="fas fa-trash"></i>`;
                        deleteButton.title = "Delete Chat";
                        deleteButton.onclick = (e) => {
                            e.stopPropagation();
                            deleteChat(session.session_id);
                        };

                        chatActions.appendChild(pinButton);
                        chatActions.appendChild(renameButton);
                        chatActions.appendChild(deleteButton);

                        listItem.appendChild(chatSummary);
                        listItem.appendChild(chatActions);
                        chatList.appendChild(listItem);
                    });
                } else {
                    chatList.innerHTML = '<p style="text-align: center; color: #777; margin-top: 20px;">No chats yet. Start a new one!</p>';
                }
            } catch (error) {
                console.error('Error fetching chat sessions:', error);
            }
        }

        async function loadChat(sessionId) {
            currentSessionId = sessionId;
            document.querySelectorAll('.chat-list-item').forEach(item => item.classList.remove('active'));
            const selectedItem = document.querySelector(`.chat-list-item[data-session-id="${sessionId}"]`);
            if (selectedItem) selectedItem.classList.add('active');

            await fetchChatHistory(sessionId);
        }

        async function fetchChatHistory(sessionId) {
            try {
                const response = await fetch(`/get_chat_history/${sessionId}`);
                const data = await response.json();
                chatMessages.innerHTML = '';
                if (data.status === 'success') {
                    // Display initial message and FAQs for new chats
                    if (data.messages.length === 0) {
                        displayInitialMessageAndFAQs();
                    } else {
                        data.messages.forEach(msg => {
                            displayMessage(msg.sender, msg.message_text, msg.sender === 'User' ? 'user' : 'ai');
                        });
                        // After loading existing messages, display general FAQs
                        displaySuggestedFAQs([
                            "What is Connex?",
                            "How do I register?",
                            "What kind of events are available?",
                            "How can I volunteer?"
                        ]);
                    }
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            } catch (error) {
                console.error('Error fetching chat history:', error);
            }
        }

        async function renameChat(sessionId) {
            const newName = prompt("Enter new name for this chat:");
            if (newName && newName.trim() !== "") {
                try {
                    const response = await fetch('/update_chat_session_metadata', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ chat_session_id: sessionId, name: newName })
                    });
                    const data = await response.json();
                    if (data.status === 'success') {
                        await fetchChatSessions();
                    } else {
                        alert('Failed to rename chat.');
                    }
                } catch (error) {
                    console.error('Error renaming chat:', error);
                }
            }
        }

        async function togglePinChat(sessionId, isPinned) {
            try {
                const response = await fetch('/update_chat_session_metadata', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chat_session_id: sessionId, pinned: isPinned })
                });
                const data = await response.json();
                if (data.status === 'success') {
                    await fetchChatSessions();
                } else {
                    alert('Failed to update chat pinned status.');
                }
            } catch (error) {
                console.error('Error toggling pin status:', error);
            }
        }

        async function deleteChat(sessionId) {
            if (confirm("Are you sure you want to delete this chat?")) {
                try {
                    const response = await fetch('/delete_chat_session', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ chat_session_id: sessionId })
                    });
                    const data = await response.json();
                    if (data.status === 'success') {
                        if (currentSessionId === sessionId) {
                            currentSessionId = null;
                        }
                        await fetchChatSessions();
                        // If no chats left, create a new one
                        if (document.querySelectorAll('.chat-list-item').length === 0) {
                            createNewChatSession();
                        } else if (!currentSessionId) {
                            // If the deleted chat was the active one, load the first one
                            const firstChat = document.querySelector('.chat-list-item');
                            if (firstChat) {
                                loadChat(firstChat.dataset.sessionId);
                            }
                        }
                    } else {
                        alert('Failed to delete chat.');
                    }
                } catch (error) {
                    console.error('Error deleting chat:', error);
                }
            }
        }

        function displayMessage(sender, message, type) {
            const messageRow = document.createElement('div');
            messageRow.className = `message-row ${type}`;

            const senderSpan = document.createElement('span');
            senderSpan.className = 'message-sender';
            senderSpan.textContent = sender;

            const messageBubble = document.createElement('div');
            messageBubble.className = 'message-bubble';
            messageBubble.innerHTML = message;

            if (type === 'user') {
                messageRow.appendChild(senderSpan);
                messageRow.appendChild(messageBubble);
            } else {
                messageRow.appendChild(senderSpan);
                messageRow.appendChild(messageBubble);
            }
            chatMessages.appendChild(messageRow);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function displaySuggestedFAQs(faqs) {
            const existingFaqContainer = document.querySelector('.suggested-faqs');
            if (existingFaqContainer) existingFaqContainer.remove();

            const faqContainer = document.createElement('div');
            faqContainer.className = 'suggested-faqs';
            faqContainer.innerHTML = '<h4>Suggested Questions:</h4><ul></ul>';
            const faqList = faqContainer.querySelector('ul');

            faqs.forEach(faq => {
                const listItem = document.createElement('li');
                const button = document.createElement('button');
                button.className = 'suggested-faq-button';
                button.textContent = faq;
                button.onclick = () => {
                    chatInput.value = faq;
                    sendMessage();
                };
                listItem.appendChild(button);
                faqList.appendChild(listItem);
            });
            chatMessages.appendChild(faqContainer);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function displayInitialMessageAndFAQs() {
            displayMessage('Connex AI', "Hello! I'm Connex AI, your personal AI assistant. How can I help you today?", 'ai');
            displaySuggestedFAQs([
                "What is Connex?",
                "How do I register?",
                "What kind of events are available?",
                "How can I volunteer?"
            ]);
        }

        async function sendMessage() {
            const userMessage = chatInput.value.trim();
            if (userMessage === '') return;

            if (!currentSessionId) {
                alert("Please start a new chat session first.");
                return;
            }

            displayMessage('You', userMessage, 'user');
            chatInput.value = '';

            // Add user message to the database
            await saveMessageToDatabase(currentSessionId, 'User', userMessage);

            loadingIndicator.style.display = 'flex';
            chatMessages.scrollTop = chatMessages.scrollHeight;

            let aiResponse = "Sorry, I couldn't get a response. Please try again.";

            try {
                let faqAnswerFound = false;
                let relatedFAQs = [];

                for (const faq of faqResponses) {
                    const matchedKeyword = faq.keywords.find(keyword => 
                        userMessage.toLowerCase().includes(keyword.toLowerCase())
                    );
                    if (matchedKeyword) {
                        aiResponse = faq.answer;
                        relatedFAQs = faq.related || [];
                        faqAnswerFound = true;
                        break;
                    }
                }

                if (faqAnswerFound) {
                    displayMessage('Connex AI', aiResponse, 'ai');
                    await saveMessageToDatabase(currentSessionId, 'AI', aiResponse);
                    if (relatedFAQs.length > 0) {
                        displaySuggestedFAQs(relatedFAQs);
                    } else {
                        displaySuggestedFAQs([
                            "What is Connex?",
                            "How do I register?",
                            "What kind of events are available?",
                            "How can I volunteer?"
                        ]);
                    }
                } else {
                    const chatPayload = {
                        model: "gpt-3.5-turbo",
                        messages: await getChatHistoryForAPI(currentSessionId),
                        temperature: 0.7
                    };
                    const apiKey = OPENAI_API_KEY;
                    const chatApiUrl = "https://api.openai.com/v1/chat/completions";

                    const chatResponse = await fetch(chatApiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify(chatPayload)
                    });

                    const chatResult = await chatResponse.json();
                    
                    let generatedResponse = "";
                    if (chatResponse.ok && chatResult.choices && chatResult.choices.length > 0 && chatResult.choices[0].message && chatResult.choices[0].message.content) {
                        generatedResponse = chatResult.choices[0].message.content;
                    } else {
                        console.error('OpenAI Chat API error or unexpected response structure:', chatResult);
                        aiResponse = "Error: Could not retrieve a valid response from the AI.";
                        if (chatResult.error && chatResult.error.message) {
                            aiResponse = `Error from OpenAI Chat: ${chatResult.error.message}`;
                        }
                        displayMessage('Connex AI', aiResponse, 'ai');
                        await saveMessageToDatabase(currentSessionId, 'AI', aiResponse);
                        return;
                    }

                    const moderationPayload = { input: generatedResponse };
                    const moderationApiUrl = "https://api.openai.com/v1/moderations";

                    const moderationResponse = await fetch(moderationApiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify(moderationPayload)
                    });

                    const moderationResult = await moderationResponse.json();

                    if (moderationResponse.ok && moderationResult.results && moderationResult.results.length > 0) {
                        const flagged = moderationResult.results[0].flagged;
                        if (flagged) {
                            console.warn('AI response flagged by moderation API:', moderationResult.results[0].categories);
                            aiResponse = "I'm sorry, I cannot provide a response that violates my safety guidelines. Please ask something else related to Connex or digital wellness.";
                        } else {
                            aiResponse = generatedResponse;
                        }
                    } else {
                        console.error('OpenAI Moderation API error or unexpected response structure:', moderationResult);
                        aiResponse = generatedResponse;
                    }

                    displayMessage('Connex AI', aiResponse, 'ai');
                    await saveMessageToDatabase(currentSessionId, 'AI', aiResponse);

                    const generalFAQs = [
                        "What is Connex?",
                        "How do I register?",
                        "What kind of events are available?",
                        "How can I volunteer?"
                    ];
                    displaySuggestedFAQs(generalFAQs);
                }
            } catch (error) {
                console.error('Error communicating with AI:', error);
                const errorMessage = `There was an error connecting to the AI: ${error.message || error}. Please try again later.`;
                displayMessage('Connex AI', errorMessage, 'ai');
                await saveMessageToDatabase(currentSessionId, 'AI', errorMessage);
            } finally {
                loadingIndicator.style.display = 'none';
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        async function saveMessageToDatabase(sessionId, sender, messageText) {
            try {
                await fetch('/send_chat_message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chat_session_id: sessionId, sender: sender, message: messageText })
                });
            } catch (error) {
                console.error('Error saving message to database:', error);
            }
        }

        async function getChatHistoryForAPI(sessionId) {
            const response = await fetch(`/get_chat_history/${sessionId}`);
            const data = await response.json();
            if (data.status === 'success') {
                const history = [{ role: "system", content: systemMessage.content }];
                data.messages.forEach(msg => {
                    history.push({ role: msg.sender.toLowerCase(), content: msg.message_text });
                });
                return history;
            }
            return [{ role: "system", content: systemMessage.content }];
        }

        sendButton.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async () => {
            await fetchChatSessions();
            if (document.querySelectorAll('.chat-list-item').length > 0) {
                const firstChatId = document.querySelectorAll('.chat-list-item')[0].dataset.sessionId;
                await loadChat(firstChatId);
            } else {
                createNewChatSession();
            }
        });
    </script>
    {% if is_admin %}
        <!-- Idle Timeout Popup -->
        <div id="idlePopup" style="display: none; flex-direction: column;">
            <div>
            <h3>Youâ€™ve been idle for a while</h3>
            <p>Your session will be terminated in <span id="countdown">15</span> seconds.</p>
            <div style="margin-top: 20px;">
                <button class="stay-btn" onclick="stayLoggedIn()">Stay Logged In</button>
                <button class="logout-btn" onclick="goToLogout()">Log Out Now</button>
            </div>
            </div>
        </div>
        <script>
            // Idle Timeout Logic
            let idleTimeLimit = 5 * 1000; // 15 seconds

            let warningDuration = 15; // 15 seconds countdown
            let idleTimeout, countdownTimer;
            let countdownValue = warningDuration;

            function resetIdleTimer(event) {
                // if event target is inside popup, do nothing
                const popup = document.getElementById("idlePopup");
                if (popup.style.display === "flex" && popup.contains(event.target)) {
                return; // ignore events inside popup so countdown continues
                }

                clearTimeout(idleTimeout);
                clearInterval(countdownTimer);
                hidePopup();
                countdownValue = warningDuration;

                idleTimeout = setTimeout(showIdlePopup, idleTimeLimit);
            }

            // Attach listeners to detect user activity
            ['click', 'mousemove', 'keydown', 'scroll'].forEach(eventName => {
                window.addEventListener(eventName, resetIdleTimer);
            });



            function showIdlePopup() {
                document.getElementById("idlePopup").style.display = "flex";
                countdownTimer = setInterval(() => {
                countdownValue--;
                document.getElementById("countdown").textContent = countdownValue;
                if (countdownValue <= 0) {
                    clearInterval(countdownTimer);
                    goToLogout();
                }
                }, 1000);
            }

            function hidePopup() {
                document.getElementById("idlePopup").style.display = "none";
            }

            function stayLoggedIn() {
                hidePopup();
                resetIdleTimer();
                fetch('/ping');
            }


            function goToLogout() {
                window.location.href = "/logout";
            }

            ['click', 'mousemove', 'keydown', 'scroll'].forEach(event => {
                window.addEventListener(event, resetIdleTimer);
            });

            resetIdleTimer(); // Initialize on load
        </script>
    {% endif %}
</body>
</html>