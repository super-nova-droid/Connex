{% include "includes/navbar.html" %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chatbot - Connex AI</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            min-height: 100vh;
            font-family: 'Poppins', sans-serif;
            display: flex;
            flex-direction: column;
            color: #FFE6F0;
        }

        .content-wrapper {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 85px);
            overflow: hidden;
        }

        .chat-container {
            display: flex;
            flex: 1;
            overflow: hidden;
            margin: 20px;
            gap: 20px;
        }
        
        /* Chat Sessions Sidebar */
        .sidebar-container {
            width: 300px;
            min-width: 300px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            position: relative;
            z-index: 9;
            /* Add slide-in animation */
            opacity: 0;
            transform: translateX(-30px);
            animation: slideInLeft 0.6s ease-out forwards;

        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            /* Add animation */
            opacity: 0;
            transform: translateY(-20px);
            animation: slideInDown 0.5s ease-out 0.2s forwards;
        }

        .sidebar-header h3 {
            margin: 0;
            color: #ffffff;
            font-size: 1.3em;
            font-weight: 600;
        }

        .new-chat-btn {
            background: rgba(180, 100, 140, 0.4);
            border: 2px solid rgba(180, 100, 140, 0.6);
            color: #ffffff;
            padding: 10px 15px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-top: 10px;
        }

        .new-chat-btn:hover {
            background: rgba(180, 100, 140, 0.6);
            border-color: rgba(180, 100, 140, 0.8);
            transform: translateY(-1px);
        }

        .chat-list {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            /* Add animation */
            opacity: 0;
            animation: fadeInUp 0.6s ease-out 0.3s forwards;
        }

        .chat-list-item {
            padding: 15px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            /* Add staggered animation */
            opacity: 0;
            transform: translateX(-20px);
            animation: slideInLeft 0.4s ease-out forwards;
        }

        /* Stagger chat item animations */
        .chat-list-item:nth-child(1) { animation-delay: 0.4s; }
        .chat-list-item:nth-child(2) { animation-delay: 0.45s; }
        .chat-list-item:nth-child(3) { animation-delay: 0.5s; }
        .chat-list-item:nth-child(4) { animation-delay: 0.55s; }
        .chat-list-item:nth-child(5) { animation-delay: 0.6s; }
        .chat-list-item:nth-child(6) { animation-delay: 0.65s; }

        .chat-list-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .chat-list-item.active {
            background: rgba(180, 100, 140, 0.4);
            border-color: rgba(180, 100, 140, 0.6);
            color: #ffffff;
        }

        .chat-list-item.pinned {
            background: rgba(255, 193, 7, 0.2);
            border-color: rgba(255, 193, 7, 0.4);
            order: -1;
        }

        .chat-summary-text {
            flex: 1;
            font-weight: 600;
            font-size: 16px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-actions {
            display: flex;
            gap: 5px;
            margin-left: 10px;
        }

        .chat-actions button {
            background: none;
            border: none;
            font-size: 1.1em;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.7);
            transition: color 0.2s;
            padding: 5px;
        }

        .chat-actions button:hover {
            color: #ffffff;
        }

        .chat-actions .pin-icon {
            color: rgba(255, 255, 255, 0.5);
        }

        .chat-list-item.pinned .chat-actions .pin-icon {
            color: #ffcc00;
        }

        /* Main Chat Area */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            overflow: hidden;
            position: relative;
            /* Add slide-in animation */
            opacity: 0;
            transform: translateX(30px);
            animation: slideInRight 0.6s ease-out 0.1s forwards;
        }

        .chatbot-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 15px;
            color: #ffffff;
            font-size: 1.5em;
            font-weight: 600;
            /* Add animation */
            opacity: 0;
            transform: translateY(-20px);
            animation: slideInDown 0.5s ease-out 0.3s forwards;
        }

        .chatbot-alert {
            background: rgba(255, 123, 189, 0.2);
            color: #ffffff;
            padding: 18px 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 1.1em;
            font-weight: 500;
            border-bottom: 1px solid rgba(255, 123, 189, 0.3);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            /* Add animation */
            opacity: 0;
            transform: translateY(-10px);
            animation: slideInDown 0.5s ease-out 0.4s forwards;
        }

        .chatbot-alert img {
            height: 35px;
            width: 35px;
            margin-right: 15px;
            vertical-align: middle;
        }

        .chatbot-alert-text {
            flex-grow: 1;
            display: flex;
            align-items: center;
        }

        .chatbot-alert .close-btn {
            background: none;
            border: none;
            font-size: 1.8em;
            color: #ffffff;
            cursor: pointer;
            padding: 0 8px;
            transition: color 0.2s;
        }

        .chatbot-alert .close-btn:hover {
            color: rgba(255, 255, 255, 0.7);
        }

        /* Chat Messages Area */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            min-height: 0;
            /* Add animation */
            opacity: 0;
            animation: fadeInUp 0.6s ease-out 0.5s forwards;
        }

        .message-row {
            display: flex;
            margin-bottom: 20px;
            align-items: flex-end;
        }

        .message-row.user {
            justify-content: flex-end;
        }

        .message-row.ai {
            justify-content: flex-start;
        }

        .message-bubble {
            max-width: 75%;
            padding: 15px 20px;
            border-radius: 15px;
            font-size: 15px;
            line-height: 1.5;
            word-wrap: break-word;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .message-row.user .message-bubble {
            background: rgba(180, 100, 140, 0.4);
            color: #ffffff;
            border-bottom-right-radius: 5px;
        }

        .message-row.ai .message-bubble {
            background: rgba(255, 255, 255, 0.15);
            color: #ffffff;
            border-bottom-left-radius: 5px;
        }

        .message-sender {
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 8px;
            display: block;
        }

        .message-row.user .message-sender {
            text-align: right;
            margin-right: 30px;
        }

        .message-row.ai .message-sender {
            text-align: left;
            margin-right: 50px;
        }

        /* Chat Input Area */
        .chat-input-area {
            padding: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            flex-shrink: 0;
            /* Add animation */
            opacity: 0;
            transform: translateY(20px);
            animation: slideInUp 0.5s ease-out 0.6s forwards;
        }

        .chat-input-area {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            min-height: 45px;
            max-height: 120px;
            padding: 12px 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: #ffffff;
            font-size: 15px;
            font-family: 'Poppins', sans-serif;
            outline: none;
            resize: vertical;
            transition: all 0.3s ease;
        }

        .chat-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .chat-input:focus {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(180, 100, 140, 0.8);
            box-shadow: 0 0 0 3px rgba(180, 100, 140, 0.2);
        }

        .send-button {
            padding: 12px 20px;
            background: rgba(180, 100, 140, 0.4);
            border: 2px solid rgba(180, 100, 140, 0.6);
            border-radius: 12px;
            color: #ffffff;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            flex-shrink: 0;
        }

        .send-button:hover:not(:disabled) {
            background: rgba(180, 100, 140, 0.6);
            border-color: rgba(180, 100, 140, 0.8);
            transform: translateY(-1px);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .loading-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
            color: rgba(255, 255, 255, 0.7);
            font-style: italic;
            margin-top: 10px;
            margin-bottom: 10px;
        }

        .loading-indicator .dot {
            width: 10px;
            height: 10px;
            background-color: rgba(180, 100, 140, 0.8);
            border-radius: 50%;
            margin: 0 4px;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .loading-indicator .dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-indicator .dot:nth-child(2) { animation-delay: -0.16s; }
        .loading-indicator .dot:nth-child(3) { animation-delay: 0s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* Styles for suggested FAQs */
        .suggested-faqs {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .suggested-faqs h4 {
            color: #ffffff;
            margin-bottom: 10px;
            font-size: 1.05em;
        }

        .suggested-faqs ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .suggested-faqs li {
            display: inline-block;
        }

        .suggested-faq-button {
            background: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            text-decoration: none;
        }

        .suggested-faq-button:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-1px);
        }

        /* Scrollbar Styling */
        .chat-messages::-webkit-scrollbar,
        .chat-list::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track,
        .chat-list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb,
        .chat-list::-webkit-scrollbar-thumb {
            background: rgba(180, 100, 140, 0.6);
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover,
        .chat-list::-webkit-scrollbar-thumb:hover {
            background: rgba(180, 100, 140, 0.8);
        }

        /* Animation keyframes */
        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .content-wrapper {
                height: calc(100vh - 70px);
            }

            .chat-container {
                margin: 10px;
                gap: 10px;
                flex-direction: column;
            }

            .sidebar-container {
                width: 100%;
                height: 200px;
                order: 2;
                /* Update mobile animation */
                animation: slideInUp 0.6s ease-out forwards;
            }

            .main-content {
                height: calc(100vh - 300px);
                order: 1;
                /* Update mobile animation */
                animation: slideInUp 0.6s ease-out 0.1s forwards;
            }

            .chat-list {
                padding: 10px;
                display: flex;
                gap: 10px;
                overflow-x: auto;
                overflow-y: hidden;
            }

            .chat-list-item {
                min-width: 200px;
                margin-bottom: 0;
                flex-shrink: 0;
            }

            .message-bubble {
                max-width: 90%;
                padding: 12px 16px;
                font-size: 14px;
            }

            .chat-input {
                font-size: 14px;
            }

            .chatbot-header {
                font-size: 1.2em;
            }
        }
    </style>
</head>
<body>
    {% include 'includes/bg.html' %}
    
    <div class="content-wrapper">
        <div class="chat-container">
            <!-- Chat List Panel -->
            <div class="sidebar-container" id="sidebarContainer">
                <div class="sidebar-header">
                    <h3>AI Chats</h3>
                    <button class="new-chat-btn" onclick="newChat()">+ New Chat</button>
                </div>
                <div class="chat-list" id="chatList">
                </div>
            </div>

            <!-- Main Chat Panel -->
            <div class="main-content">
                <div class="chatbot-header">AI Chatbot</div>

                <div class="chatbot-alert" id="chatbotAlert">
                    <div class="chatbot-alert-text">
                        <img src="{{ url_for('static', filename='images/image.png') }}" alt="AI Icon" style="height: 50px; width: 45px;">
                        CONNEX AI: Chat with Connex AI! Your Personal AI assistant!
                    </div>
                    <button class="close-btn" onclick="document.getElementById('chatbotAlert').style.display='none';">&times;</button>
                </div>
                
                <div class="chat-messages" id="chatMessages">
                </div>

                <div class="loading-indicator" id="loadingIndicator">
                    <div class="dot"></div><div class="dot"></div><div class="dot"></div>
                </div>
                
                <div class="chat-input-area">
                    <input type="text" id="chatInput" class="chat-input" placeholder="Enter Query">
                    <button id="sendButton" class="send-button">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    // Define the API key using Jinja2 to get it from Flask
    const OPENAI_API_KEY = "{{ openai_api_key }}";
    console.log("OpenAI API Key received in JS:", OPENAI_API_KEY);

    const chatMessages = document.getElementById('chatMessages');
    const chatInput = document.getElementById('chatInput');
    const sendButton = document.getElementById('sendButton');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const sidebarContainer = document.getElementById('sidebarContainer');
    const chatList = document.getElementById('chatList');
    const newChatButton = document.getElementById('newChatButton'); // Assuming you have a new chat button with this ID

    loadingIndicator.style.display = 'none'; // Ensure it's hidden on load

    // Global variable to store current chat session ID and its history
    let currentChatSessionId = null;
    let currentChatHistory = []; // Stores messages for the currently active chat, including system message
    let allChatSessions = {}; // Stores metadata for all sessions (id, name, pinned, etc.)

    // Initial system message - this should be part of every chat's history sent to AI
    const systemMessage = { role: "system", content: "You are Connex AI, a helpful assistant for a digital wellness platform for seniors and volunteers where they can sign up or volunteer for events. Your primary function is to answer questions strictly related to Connex, its website, its events, and general information about digital wellness for seniors. If a user asks a question outside these topics, you must politely decline to answer and gently guide them back to relevant subjects. For example, you can say: 'I'm sorry, I only provide information related to Connex and digital wellness for seniors. How can I help you with that?' Do not engage in political discussions, provide medical diagnoses, or offer financial advice." };

    // --- Predefined FAQ Scenarios ---
    const faqResponses = [
        {
            keywords: ["about connex", "what is connex", "connex platform"],
            answer: "Connex is a digital wellness platform designed to connect seniors with volunteers for various events and activities, fostering a supportive community.",
            related: ["How do I register?", "What kind of events are available?", "How can I volunteer?"]
        },
        {
            keywords: ["register", "sign up", "create account", "join connex"],
            answer: "To register, click on the 'Sign Up' button in the navigation bar or go directly to our <a href='/signup' target='_blank'>registration page</a> and follow the prompts to create your account.",
            related: ["Who can register?", "Do I need an email to sign up?", "What information is required for registration?"]
        },
        {
            keywords: ["events", "what events", "find events", "event details", "upcoming events"],
            answer: "We offer a variety of events, including digital literacy workshops, social gatherings, fitness classes, and more. You can browse all upcoming events on our <a href='/usereventpage' target='_blank'>Events page</a>.",
            related: ["How can I join an event?", "Are events free?", "How do I suggest a new event?"]
        },
        {
            keywords: ["volunteer", "how to volunteer", "become a volunteer", "volunteering"],
            answer: "To become a volunteer, you will have to create a new account and check the box for signup as volunteer in the <a href='/signup' target='_blank'>Sign Up Page</a>. Once you login, you will be able to volunteer for events!",
            related: ["What are the requirements for volunteers?", "What kind of tasks do volunteers do?", "How can I get started as a volunteer?"]
        },
        {
            keywords: ["contact", "support", "help", "customer service", "get in touch"],
            answer: "If you need further assistance, please visit our <a href='/support' target='_blank'>Support page</a> or email us directly at support@connex.com. Our team will be happy to help you.",
            related: ["What are your office hours?", "Do you have a phone number?", "Where can I find FAQs?"]
        },
        {
            keywords: ["digital wellness", "seniors digital", "online safety", "tech tips", "cyber security"],
            answer: "Digital wellness for seniors focuses on empowering older adults to confidently and safely use technology. This includes topics like online safety, privacy, digital literacy, and using technology for connection and well-being.",
            related: ["What are common online scams?", "How can seniors stay safe online?", "Are there workshops on using smartphones?"]
        },
        {
            keywords: ["password reset", "forgot password", "login issues"],
            answer: "If you forgot your password, go to the login page and click on 'Forgot Password'. You will be guided through the steps to reset it.",
            related: ["How do I change my email?", "My account is locked, what do I do?"]
        },
        {
            keywords: ["cancel event", "unregister event", "withdraw from event"],
            answer: "You can cancel your attendance for an event by going to 'My Events' in your profile and selecting the event you wish to cancel.",
            related: ["What is the cancellation policy?", "Can I join another event instead?"]
        },
        {
            keywords: ["visit home", "go to homepage", "connex home"],
            answer: "You can always return to the homepage by clicking the 'Connex AI' logo in the navigation bar or by visiting our <a href='/' target='_blank'>home page</a>.",
            related: ["What is Connex?", "How do I register?"]
        },
        {
            keywords: ["view calendar", "my events calendar"],
            answer: "You can view your signed-up events and volunteered events on the calendar page here: <a href='/calendar' target='_blank'>My Calendar</a>.",
            related: ["How do I sign up for an event?", "How do I remove an event from my calendar?"]
        }
    ];

    // --- API Interaction Functions ---

    // Fetches all chat sessions for the current user from the database
    async function fetchChatSessions() {
        try {
            const response = await fetch('/get_chat_sessions');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            if (data.status === 'success') {
                allChatSessions = {}; // Clear previous sessions
                data.sessions.forEach(session => {
                    allChatSessions[session.session_id] = session;
                });
                renderChatList();
                // Load the most recent chat if available, otherwise create a new one
                if (Object.keys(allChatSessions).length > 0) {
                    const sortedSessions = Object.values(allChatSessions).sort((a, b) => new Date(b.last_message_timestamp) - new Date(a.last_message_timestamp));
                    loadChat(sortedSessions[0].session_id);
                } else {
                    newChat();
                }
            } else {
                console.error('Error fetching chat sessions:', data.message);
                displayMessage('Connex AI', 'Could not load your chat sessions. Please try again later.', 'ai');
            }
        } catch (error) {
            console.error('Network error fetching chat sessions:', error);
            displayMessage('Connex AI', 'Failed to connect to the server to load chat sessions. Please check your internet connection.', 'ai');
        }
    }

    // Creates a new chat session in the database
    async function createNewChatSessionInDB() {
        try {
            const response = await fetch('/create_new_chat_session', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            if (data.status === 'success') {
                return data.session_id;
            } else {
                console.error('Error creating new chat session:', data.message);
                displayMessage('Connex AI', 'Could not create a new chat session. Please try again.', 'ai');
                return null;
            }
        } catch (error) {
            console.error('Network error creating new chat session:', error);
            displayMessage('Connex AI', 'Failed to connect to the server to create a new chat. Please check your internet connection.', 'ai');
            return null;
        }
    }

    // Fetches chat history for a specific session from the database
    async function fetchChatHistoryFromDB(sessionId) {
        try {
            const response = await fetch(`/get_chat_history/${sessionId}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            if (data.status === 'success') {
                return data.messages;
            } else {
                console.error('Error fetching chat history:', data.message);
                displayMessage('Connex AI', 'Could not load chat history. Please try again.', 'ai');
                return [];
            }
        } catch (error) {
            console.error('Network error fetching chat history:', error);
            displayMessage('Connex AI', 'Failed to connect to the server to load chat history. Please check your internet connection.', 'ai');
            return [];
        }
    }

    // Saves a single message to the database
    async function saveMessageToDB(sessionId, sender, messageText) {
        try {
            const response = await fetch('/send_chat_message', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    chat_session_id: sessionId,
                    sender: sender,
                    message: messageText
                })
            });
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            if (data.status !== 'success') {
                console.error('Error saving message to DB:', data.message);
            }
        } catch (error) {
            console.error('Network error saving message to DB:', error);
        }
    }

    // Updates chat session metadata (name, pinned) in the database
    async function updateChatSessionMetadataInDB(sessionId, updates) {
        try {
            const response = await fetch('/update_chat_session_metadata', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ chat_session_id: sessionId, ...updates })
            });
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            if (data.status !== 'success') {
                console.error('Error updating chat metadata in DB:', data.message);
            }
        } catch (error) {
            console.error('Network error updating chat metadata in DB:', error);
        }
    }

    // Deletes a chat session from the database
    async function deleteChatSessionFromDB(sessionId) {
        try {
            const response = await fetch('/delete_chat_session', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ chat_session_id: sessionId })
            });
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            if (data.status !== 'success') {
                console.error('Error deleting chat from DB:', data.message);
            }
        } catch (error) {
            console.error('Network error deleting chat from DB:', error);
        }
    }

    // --- Core Chat UI Logic (Modified) ---

    // Render the chat list in the sidebar based on allChatSessions
    function renderChatList() {
        chatList.innerHTML = ''; // Clear existing list

        const sortedSessions = Object.values(allChatSessions).sort((a, b) => {
            if (a.pinned && !b.pinned) return -1;
            if (!a.pinned && b.pinned) return 1;
            // Sort by last message timestamp for unpinned, or creation time for pinned if no messages
            return new Date(b.last_message_timestamp || b.created_at) - new Date(a.last_message_timestamp || a.created_at);
        });

        if (sortedSessions.length === 0) {
            chatList.innerHTML = '<p style="text-align: center; color: #777; margin-top: 20px;">No chats yet. Start a new one!</p>';
            return;
        }

        sortedSessions.forEach(session => {
            const listItem = document.createElement('div');
            listItem.className = `chat-list-item ${session.session_id === currentChatSessionId ? 'active' : ''} ${session.pinned ? 'pinned' : ''}`;
            listItem.dataset.chatId = session.session_id;
            listItem.onclick = () => loadChat(session.session_id);

            const chatSummary = document.createElement('span');
            chatSummary.className = 'chat-summary-text';
            chatSummary.textContent = session.name || "New Chat"; // Display chat name or default

            const chatActions = document.createElement('div');
            chatActions.className = 'chat-actions';

            // Pin/Unpin button
            const pinButton = document.createElement('button');
            pinButton.innerHTML = `<i class="fas fa-thumbtack pin-icon"></i>`;
            pinButton.title = session.pinned ? "Unpin Chat" : "Pin Chat";
            pinButton.onclick = async (e) => {
                e.stopPropagation(); // Prevent loading chat when clicking pin
                await togglePinChat(session.session_id);
            };

            // Rename button
            const renameButton = document.createElement('button');
            renameButton.innerHTML = `<i class="fas fa-pen"></i>`;
            renameButton.title = "Rename Chat";
            renameButton.onclick = async (e) => {
                e.stopPropagation(); // Prevent loading chat when clicking rename
                await renameChat(session.session_id);
            };

            // Delete button
            const deleteButton = document.createElement('button');
            deleteButton.innerHTML = `<i class="fas fa-trash"></i>`;
            deleteButton.title = "Delete Chat";
            deleteButton.onclick = async (e) => {
                e.stopPropagation(); // Prevent loading chat when clicking delete
                await deleteChat(session.session_id);
            };

            chatActions.appendChild(pinButton);
            chatActions.appendChild(renameButton);
            chatActions.appendChild(deleteButton);

            listItem.appendChild(chatSummary);
            listItem.appendChild(chatActions);
            chatList.appendChild(listItem);
        });
    }

    // Create a new chat session (client-side and then save to DB)
    async function newChat() {
        const sessionId = await createNewChatSessionInDB();
        if (sessionId) {
            allChatSessions[sessionId] = {
                session_id: sessionId,
                name: "New Chat",
                pinned: false,
                created_at: new Date().toISOString(),
                last_message_timestamp: new Date().toISOString()
            };
            currentChatSessionId = sessionId;
            currentChatHistory = [systemMessage, { role: "assistant", content: "Hello! I'm Connex AI, your personal AI assistant. How can I help you today?" }];
            renderChatList(); // Update sidebar list
            displayChatHistory(); // Display the initial messages
            displaySuggestedFAQs([
                "What is Connex?",
                "How do I register?",
                "What kind of events are available?",
                "How can I volunteer?"
            ]);
            chatInput.focus();
        }
    }

    // Load a specific chat's history from the database
    async function loadChat(sessionId) {
        currentChatSessionId = sessionId;
        
        // Update active class in sidebar
        document.querySelectorAll('.chat-list-item').forEach(item => {
            item.classList.remove('active');
        });
        const selectedItem = document.querySelector(`.chat-list-item[data-chat-id="${sessionId}"]`);
        if (selectedItem) {
            selectedItem.classList.add('active');
        }

        loadingIndicator.style.display = 'flex';
        chatMessages.innerHTML = ''; // Clear current messages

        try {
            const messages = await fetchChatHistoryFromDB(sessionId);
            currentChatHistory = [systemMessage, ...messages]; // Always include system message for AI API

            displayChatHistory(); // Display the loaded messages

            // After loading a chat, re-display the initial FAQs if the chat is new or has few messages
            // (excluding the system message and initial AI greeting)
            const actualMessagesCount = currentChatHistory.length - 1; // Subtract system message
            if (actualMessagesCount <= 1) { // Only initial AI message
                const initialFAQs = [
                    "What is Connex?",
                    "How do I register?",
                    "What kind of events are available?",
                    "How can I volunteer?"
                ];
                displaySuggestedFAQs(initialFAQs);
            } else {
                // Clear suggested FAQs if not a new chat
                const existingFaqContainer = document.querySelector('.suggested-faqs');
                if (existingFaqContainer) {
                    existingFaqContainer.remove();
                }
            }

        } finally {
            loadingIndicator.style.display = 'none';
            chatMessages.scrollTop = chatMessages.scrollHeight; // Scroll to bottom
            chatInput.focus();
        }
    }

    // Displays currentChatHistory in the chat window
    function displayChatHistory() {
        chatMessages.innerHTML = ''; // Clear current messages
        currentChatHistory.forEach(msg => {
            if (msg.role === 'user') {
                displayMessage('You', msg.message_text || msg.content, 'user');
            } else if (msg.role === 'assistant' && msg !== systemMessage) { // Skip system message from display
                displayMessage('Connex AI', msg.message_text || msg.content, 'ai');
            }
        });
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Rename a chat session
    async function renameChat(sessionId) {
        const sessionToRename = allChatSessions[sessionId];
        if (sessionToRename) {
            let newName = prompt("Enter new name for this chat:", sessionToRename.name);
            if (newName !== null && newName.trim() !== "") {
                sessionToRename.name = newName.trim();
                await updateChatSessionMetadataInDB(sessionId, { name: sessionToRename.name });
                renderChatList(); // Re-render to update name in sidebar
            }
        }
    }

    // Toggle pin status of a chat session
    async function togglePinChat(sessionId) {
        const sessionToPin = allChatSessions[sessionId];
        if (sessionToPin) {
            sessionToPin.pinned = !sessionToPin.pinned;
            await updateChatSessionMetadataInDB(sessionId, { pinned: sessionToPin.pinned });
            renderChatList(); // Re-render to apply sorting/styling
        }
    }

    // Delete a chat session
    async function deleteChat(sessionId) {
        if (confirm("Are you sure you want to delete this chat? This action cannot be undone.")) {
            await deleteChatSessionFromDB(sessionId);
            delete allChatSessions[sessionId]; // Remove from client-side cache

            if (currentChatSessionId === sessionId) {
                currentChatSessionId = null; // No active chat after deletion
                currentChatHistory = [];
            }
            renderChatList(); // Update sidebar list

            // If the deleted chat was the active one, load the first available chat or create new
            if (Object.keys(allChatSessions).length === 0) {
                newChat(); // Automatically create a new chat if all are deleted
            } else if (currentChatSessionId === null) {
                const firstChatId = Object.keys(allChatSessions)[0];
                if (firstChatId) {
                    loadChat(firstChatId);
                }
            }
        }
    }

    // Function to display a message in the chat window
    function displayMessage(sender, message, type) {
        const messageRow = document.createElement('div');
        messageRow.className = `message-row ${type}`;

        const senderSpan = document.createElement('span');
        senderSpan.className = 'message-sender';
        senderSpan.textContent = sender;

        const messageBubble = document.createElement('div');
        messageBubble.className = 'message-bubble';
        messageBubble.innerHTML = message; // Use innerHTML to render links

        if (type === 'user') {
            messageRow.appendChild(senderSpan);
            messageRow.appendChild(messageBubble);
        } else {
            messageRow.appendChild(senderSpan);
            messageRow.appendChild(messageBubble);
        }
        chatMessages.appendChild(messageRow);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Function to display suggested FAQs
    function displaySuggestedFAQs(faqs) {
        // Remove any existing suggested FAQs before adding new ones
        const existingFaqContainer = document.querySelector('.suggested-faqs');
        if (existingFaqContainer) {
            existingFaqContainer.remove();
        }

        const faqContainer = document.createElement('div');
        faqContainer.className = 'suggested-faqs';
        faqContainer.innerHTML = '<h4>Suggested Questions:</h4><ul></ul>';
        const faqList = faqContainer.querySelector('ul');

        faqs.forEach(faq => {
            const listItem = document.createElement('li');
            const button = document.createElement('button');
            button.className = 'suggested-faq-button';
            button.textContent = faq;
            button.onclick = () => {
                chatInput.value = faq;
                sendMessage();
            };
            listItem.appendChild(button);
            faqList.appendChild(listItem);
        });
        chatMessages.appendChild(faqContainer);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Function to send message to OpenAI API and save to DB
    async function sendMessage() {
        const userMessage = chatInput.value.trim();
        if (userMessage === '') return;

        // Ensure there's an active chat, create one if not
        if (!currentChatSessionId || !allChatSessions[currentChatSessionId]) {
            await newChat(); // This will set currentChatSessionId and initialize history
            if (!currentChatSessionId) { // If newChat failed
                displayMessage('Connex AI', 'Failed to start a new chat session. Please try again.', 'ai');
                return;
            }
        }

        displayMessage('You', userMessage, 'user');
        chatInput.value = ''; // Clear input

        // Add user message to current chat's history (for AI API call)
        currentChatHistory.push({ role: "user", content: userMessage });
        // Save user message to database
        await saveMessageToDB(currentChatSessionId, 'User', userMessage);

        loadingIndicator.style.display = 'flex';
        chatMessages.scrollTop = chatMessages.scrollHeight;

        let aiResponseContent = "Sorry, I couldn't get a response. Please try again.";

        try {
            // Check if user message matches any FAQ keywords
            let faqAnswerFound = false;
            let relatedFAQs = [];

            for (const faq of faqResponses) {
                const matchedKeyword = faq.keywords.find(keyword =>
                    userMessage.toLowerCase().includes(keyword.toLowerCase())
                );
                if (matchedKeyword) {
                    aiResponseContent = faq.answer;
                    relatedFAQs = faq.related || [];
                    faqAnswerFound = true;
                    break;
                }
            }

            if (faqAnswerFound) {
                displayMessage('Connex AI', aiResponseContent, 'ai');
                // Add AI response to current chat's history
                currentChatHistory.push({ role: "assistant", content: aiResponseContent });
                // Save AI response to database
                await saveMessageToDB(currentChatSessionId, 'AI', aiResponseContent);

                if (relatedFAQs.length > 0) {
                    displaySuggestedFAQs(relatedFAQs);
                } else {
                    displaySuggestedFAQs([
                        "What is Connex?",
                        "How do I register?",
                        "What kind of events are available?",
                        "How can I volunteer?"
                    ]);
                }
            } else {
                // Call OpenAI Chat Completions API if no FAQ match
                const chatPayload = {
                    model: "gpt-3.5-turbo",
                    messages: currentChatHistory, // Send current chat's history
                    temperature: 0.7
                };
                const apiKey = OPENAI_API_KEY;
                const chatApiUrl = "https://api.openai.com/v1/chat/completions";

                const chatResponse = await fetch(chatApiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify(chatPayload)
                });

                const chatResult = await chatResponse.json();

                let generatedResponse = "";
                if (chatResponse.ok && chatResult.choices && chatResult.choices.length > 0 && chatResult.choices[0].message && chatResult.choices[0].message.content) {
                    generatedResponse = chatResult.choices[0].message.content;
                } else {
                    console.error('OpenAI Chat API error or unexpected response structure:', chatResult);
                    aiResponseContent = "Error: Could not retrieve a valid response from the AI.";
                    if (chatResult.error && chatResult.error.message) {
                        aiResponseContent = `Error from OpenAI Chat: ${chatResult.error.message}`;
                    }
                    displayMessage('Connex AI', aiResponseContent, 'ai');
                    currentChatHistory.push({ role: "assistant", content: aiResponseContent });
                    await saveMessageToDB(currentChatSessionId, 'AI', aiResponseContent);
                    return;
                }

                // Call OpenAI Moderation API
                const moderationPayload = { input: generatedResponse };
                const moderationApiUrl = "https://api.openai.com/v1/moderations";

                const moderationResponse = await fetch(moderationApiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify(moderationPayload)
                });

                const moderationResult = await moderationResponse.json();

                if (moderationResponse.ok && moderationResult.results && moderationResult.results.length > 0) {
                    const flagged = moderationResult.results[0].flagged;
                    if (flagged) {
                        console.warn('AI response flagged by moderation API:', moderationResult.results[0].categories);
                        aiResponseContent = "I'm sorry, I cannot provide a response that violates my safety guidelines. Please ask something else related to Connex or digital wellness.";
                    } else {
                        aiResponseContent = generatedResponse;
                    }
                } else {
                    console.error('OpenAI Moderation API error or unexpected response structure:', moderationResult);
                    aiResponseContent = generatedResponse; // Fallback to generated if moderation fails
                }

                displayMessage('Connex AI', aiResponseContent, 'ai');
                // Add AI response to current chat's history
                currentChatHistory.push({ role: "assistant", content: aiResponseContent });
                // Save AI response to database
                await saveMessageToDB(currentChatSessionId, 'AI', aiResponseContent);

                // After the AI responds, suggest general FAQs
                const generalFAQs = [
                    "What is Connex?",
                    "How do I register?",
                    "What kind of events are available?",
                    "How can I volunteer?"
                ];
                displaySuggestedFAQs(generalFAQs);
            }
        } catch (error) {
            console.error('Error communicating with AI or saving to DB:', error);
            const errorMessage = `There was an error processing your request: ${error.message || error}. Please try again later.`;
            displayMessage('Connex AI', errorMessage, 'ai');
            currentChatHistory.push({ role: "assistant", content: errorMessage });
            await saveMessageToDB(currentChatSessionId, 'AI', errorMessage); // Attempt to save error message
        } finally {
            loadingIndicator.style.display = 'none';
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    }

    // Event Listeners
    sendButton.addEventListener('click', sendMessage);
    chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    // New Chat Button Listener
    if (newChatButton) {
        newChatButton.addEventListener('click', newChat);
    }

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
        fetchChatSessions(); // Start by fetching all chat sessions from DB
    });
</script>
</body>
</html>