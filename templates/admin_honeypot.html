{% extends "base.html" %}

{% block title %}Honeypot Security Logs{% endblock %}

{% block head %}
<style>
    .honeypot-dashboard {
        padding: 20px;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border-left: 4px solid #007bff;
    }
    
    .stat-card.danger {
        border-left-color: #dc3545;
    }
    
    .stat-card.warning {
        border-left-color: #ffc107;
    }
    
    .stat-card.success {
        border-left-color: #28a745;
    }
    
    .stat-number {
        font-size: 2rem;
        font-weight: bold;
        color: #333;
    }
    
    .stat-label {
        color: #666;
        margin-top: 5px;
    }
    
    .logs-section {
        background: white;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .log-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }
    
    .log-table th,
    .log-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #ddd;
    }
    
    .log-table th {
        background-color: #f8f9fa;
        font-weight: 600;
    }
    
    .log-table tr:hover {
        background-color: #f5f5f5;
    }
    
    .client-type-badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.85em;
        font-weight: 500;
    }
    
    .client-type-bot {
        background-color: #dc3545;
        color: white;
    }
    
    .client-type-browser {
        background-color: #28a745;
        color: white;
    }
    
    .client-type-suspicious {
        background-color: #ffc107;
        color: black;
    }
    
    .client-type-unknown {
        background-color: #6c757d;
        color: white;
    }
    
    .user-agent-cell {
        max-width: 300px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        cursor: pointer;
    }
    
    .user-agent-cell:hover {
        background-color: #e9ecef;
    }
    
    .user-agent-expanded {
        white-space: normal !important;
        overflow: visible !important;
        text-overflow: unset !important;
    }
    
    .alert-box {
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 4px;
        border-left: 4px solid;
    }
    
    .alert-danger {
        background-color: #f8d7da;
        border-color: #dc3545;
        color: #721c24;
    }
    
    .refresh-notice {
        background-color: #d1ecf1;
        border-color: #bee5eb;
        color: #0c5460;
        padding: 10px;
        border-radius: 4px;
        margin-bottom: 20px;
        border-left: 4px solid #17a2b8;
    }
</style>
{% endblock %}

{% block content %}
<div class="honeypot-dashboard">
    <h1>üçØ Honeypot Security Dashboard</h1>
    <p class="text-muted">Monitor unauthorized access attempts to honeypot pages</p>
    
    <div class="refresh-notice">
        <strong>Auto-refresh:</strong> This page automatically refreshes every 30 seconds to show the latest threats.
    </div>
    
    {% if bot_stats %}
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number">{{ bot_stats.total_accesses or 0 }}</div>
            <div class="stat-label">Total Access Attempts</div>
        </div>
        
        <div class="stat-card danger">
            <div class="stat-number">{{ bot_stats.bot_accesses or 0 }}</div>
            <div class="stat-label">Bot/Crawler Attempts</div>
        </div>
        
        <div class="stat-card success">
            <div class="stat-number">{{ bot_stats.browser_accesses or 0 }}</div>
            <div class="stat-label">Browser Attempts</div>
        </div>
        
        <div class="stat-card warning">
            <div class="stat-number">{{ bot_stats.suspicious_accesses or 0 }}</div>
            <div class="stat-label">Suspicious Attempts</div>
        </div>
    </div>
    {% endif %}
    
    {% if suspicious_agents %}
    <div class="logs-section">
        <h3>üö® Suspicious User-Agents (Multiple Access Attempts)</h3>
        
        {% if suspicious_agents|length > 5 %}
        <div class="alert-box alert-danger">
            <strong>High Alert:</strong> {{ suspicious_agents|length }} different User-Agents have made multiple access attempts to honeypot pages.
        </div>
        {% endif %}
        
        <table class="log-table">
            <thead>
                <tr>
                    <th>User-Agent</th>
                    <th>Client Type</th>
                    <th>Access Count</th>
                    <th>Last Access</th>
                    <th>Risk Level</th>
                </tr>
            </thead>
            <tbody>
                {% for agent in suspicious_agents[:20] %}
                <tr>
                    <td class="user-agent-cell" title="{{ agent.user_agent or 'Unknown' }}">
                        {{ (agent.user_agent or 'Unknown')[:60] }}{% if (agent.user_agent or '')|length > 60 %}...{% endif %}
                    </td>
                    <td>
                        {% if agent.client_type %}
                        <span class="client-type-badge client-type-{{ agent.client_type.lower().replace('/', '-').replace(' ', '-') }}">
                            {{ agent.client_type }}
                        </span>
                        {% else %}
                        <span class="client-type-badge client-type-unknown">Unknown</span>
                        {% endif %}
                    </td>
                    <td>{{ agent.access_count }}</td>
                    <td>{{ agent.last_access.strftime('%Y-%m-%d %H:%M:%S') if agent.last_access else 'Unknown' }}</td>
                    <td>
                        {% if agent.access_count > 10 %}
                            <span class="badge badge-danger">Critical</span>
                        {% elif agent.access_count > 5 %}
                            <span class="badge badge-warning">High</span>
                        {% else %}
                            <span class="badge badge-info">Medium</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
    
    <div class="logs-section">
        <h3>üìã Recent Honeypot Access Logs</h3>
        
        {% if logs %}
        <table class="log-table">
            <thead>
                <tr>
                    <th>Timestamp</th>
                    <th>Webpage</th>
                    <th>User-Agent Info</th>
                    <th>Description</th>
                    <th>Input Data</th>
                </tr>
            </thead>
            <tbody>
                {% for log in logs %}
                <tr>
                    <td>{{ log.access_time.strftime('%Y-%m-%d %H:%M:%S') if log.access_time else 'Unknown' }}</td>
                    <td>{{ log.webpage or 'Unknown' }}</td>
                    <td class="user-agent-cell" title="{{ log.user_agent_info or log.user_agent or 'Unknown' }}">
                        {% set ua_info = log.user_agent_info or log.user_agent or 'Unknown' %}
                        {{ ua_info[:50] }}{% if ua_info|length > 50 %}...{% endif %}
                    </td>
                    <td>{{ log.description or 'No description' }}</td>
                    <td>
                        {% if log.input1 and log.input1 != 'null' %}
                            <small><strong>Q1:</strong> {{ log.input1[:30] }}{% if log.input1|length > 30 %}...{% endif %}</small><br>
                        {% endif %}
                        {% if log.input2 and log.input2 != 'null' %}
                            <small><strong>Q2:</strong> {{ log.input2[:30] }}{% if log.input2|length > 30 %}...{% endif %}</small><br>
                        {% endif %}
                        {% if log.input3 and log.input3 != 'null' %}
                            <small><strong>Q3:</strong> {{ log.input3[:30] }}{% if log.input3|length > 30 %}...{% endif %}</small>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <div class="alert alert-info">
            <h5>No honeypot access attempts detected</h5>
            <p>This is good news! No unauthorized access attempts have been logged recently.</p>
            <p><strong>Test the honeypot:</strong> Visit <a href="/security_question" target="_blank">/security_question</a> to test if logging works.</p>
        </div>
        {% endif %}
    </div>
    
    <div class="logs-section">
        <h3>‚ÑπÔ∏è About This Dashboard</h3>
        <p><strong>What is this?</strong> This dashboard monitors access attempts to "honeypot" pages - decoy pages designed to detect unauthorized access attempts or automated bots.</p>
        
        <ul>
            <li><strong>User-Agent Analysis:</strong> We analyze the User-Agent string to distinguish between legitimate browsers and automated bots/crawlers.</li>
            <li><strong>Risk Assessment:</strong> Multiple access attempts from the same User-Agent indicate potential automated scanning or malicious activity.</li>
            <li><strong>Security Monitoring:</strong> This helps identify security threats and unauthorized access patterns.</li>
        </ul>
        
        <div class="mt-3">
            <h5>Client Type Legend:</h5>
            <span class="client-type-badge client-type-browser">Browser</span> - Legitimate web browser
            <span class="client-type-badge client-type-bot">Bot/Crawler</span> - Automated bot or crawler
            <span class="client-type-badge client-type-suspicious">Mixed/Suspicious</span> - Potentially spoofed or suspicious
            <span class="client-type-badge client-type-unknown">Unknown/Custom</span> - Unidentified client type
        </div>
    </div>
</div>

<script>
// Auto-refresh every 30 seconds
setTimeout(function() {
    location.reload();
}, 30000);

// Add click handler for expandable user-agent cells
document.querySelectorAll('.user-agent-cell').forEach(cell => {
    cell.addEventListener('click', function() {
        this.classList.toggle('user-agent-expanded');
    });
});
</script>
{% endblock %}
